<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fuse Time-Current Curves</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    .wrap { position: relative; width: 90%; height: 80vh; margin: 0 auto; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Fuse Time-Current Curves</h2>

  <div style="text-align:center; margin:20px;">
    <label for="fuseDropdown">Select a Fuse:</label>
    <select id="fuseDropdown"></select>
  </div>

  <div class="wrap">
    <div id="chart" style="width:100%;height:100%;"></div>
  </div>

<script>
  const PLOT_CONFIG = {
    responsive: true,
    displayModeBar: true,
    scrollZoom: false,     // stop wheel-zoom
    doubleClick: false,    // stop double-click autorange zoom
  };

  let denseTraceIndex = 1;
  let cursorTraceIndex = 2;

  function plotFuse(name, data) {
    const rawX = (data[name].x || []);
    const rawY = (data[name].y || []);
    const { X, Y } = prepSeries(rawX, rawY);
    const { denseX, denseY } = interpolateLogLog(X, Y, 600);

    const traceOriginal = {
      x: X, y: Y, mode: "lines", type: "scatter",
      line: { width: 2 },
      hoverinfo: "skip",
      name: `${name} (raw)`
    };

    // IMPORTANT: transparent line but hoverable (width>0)
    const traceDense = {
      x: denseX, y: denseY, mode: "lines", type: "scatter",
      line: { width: 3, color: "rgba(0,0,0,0)" }, // invisible but hoverable
      hoverinfo: "skip",
      name: "dense"
    };

    const traceCursor = {
      x: [denseX[0]], y: [denseY[0]],
      mode: "markers", type: "scatter",
      marker: { size: 10 },
      hovertemplate: "Current: %{x}<br>Time: %{y}<extra></extra>",
      name: "cursor"
    };

    const xMin = Math.min(...X), xMax = Math.max(...X);
    const yMin = Math.min(...Y), yMax = Math.max(...Y);

    const layout = {
      title: `Time-Current Curve: ${name}`,
      hovermode: "closest",
      dragmode: "pan",
      uirevision: name,               // keep camera while updating marker
      hoverdistance: -1,              // ← forgiving hover
      spikedistance: -1,              // ← keep spikes while inside plot
      xaxis: {
        title: "Current (A)",
        type: "log",
        range: [Math.log10(xMin)-0.05, Math.log10(xMax)+0.05],
        showspikes: true,
        spikemode: "across",
        spikesnap: "cursor"
      },
      yaxis: {
        title: "Time (s)",
        type: "log",
        range: [Math.log10(yMin)-0.05, Math.log10(yMax)+0.05],
        showspikes: true,
        spikemode: "across",
        spikesnap: "cursor"
      },
      margin: { l: 70, r: 20, t: 60, b: 60 }
    };

    Plotly.newPlot("chart", [traceOriginal, traceDense, traceCursor], layout, PLOT_CONFIG).then(gd => {
      // Update cursor to the nearest dense point the hover engine gives us
      gd.on("plotly_hover", ev => {
        const pt = ev.points && ev.points[0];
        if (!pt || pt.curveNumber !== denseTraceIndex) return;
        Plotly.restyle(gd, { x: [[pt.x]], y: [[pt.y]] }, [cursorTraceIndex]);
      });

      // Only hide when leaving the entire plot area, not just unhovering the line
      gd.addEventListener("mouseleave", () => {
        Plotly.restyle(gd, { x: [[null]], y: [[null]] }, [cursorTraceIndex]);
      });
    });
  }

  // ... keep your prepSeries and interpolateLogLog helpers and loadData as before ...
</script>
</body>
</html>

