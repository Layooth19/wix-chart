<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fuse Time-Current Curves</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h2 style="text-align:center;">Fuse Time-Current Curves</h2>

  <!-- Dropdown -->
  <div style="text-align:center; margin:20px;">
    <label for="fuseDropdown">Select a Fuse:</label>
    <select id="fuseDropdown"></select>
  </div>

  <!-- Plotly chart -->
  <div id="chart" style="width:90%;height:80%;margin:auto;"></div>

  <script>
    async function loadData() {
      const response = await fetch("fuses.json");
      const data = await response.json();

      const dropdown = document.getElementById("fuseDropdown");

      for (let fuse in data) {
        let option = document.createElement("option");
        option.value = fuse;
        option.text = fuse;
        dropdown.appendChild(option);
      }

      let firstFuse = Object.keys(data)[0];
      plotFuse(firstFuse, data);

      dropdown.addEventListener("change", function() {
        plotFuse(this.value, data);
      });
    }

    function plotFuse(fuseName, data) {
      const xs = data[fuseName].x.map(Number);
      const ys = data[fuseName].y.map(Number);

      const traceLine = {
        x: xs,
        y: ys,
        mode: "lines",
        type: "scatter",
        line: {color: "blue"},
        hoverinfo: "skip"
      };

      const traceMarker = {
        x: [xs[0]],
        y: [ys[0]],
        mode: "markers",
        type: "scatter",
        marker: {size: 10, color: "red"},
        name: "Marker"
      };

      const layout = {
        title: `Time-Current Curve: ${fuseName}`,
        hovermode: false,
        xaxis: { 
          title: "Current (A)", 
          type: "log", 
          tickvals: [1,10,100,1000,10000,100000] 
        },
        yaxis: { 
          title: "Time (s)", 
          type: "log",
          tickvals: [0.0001,0.001,0.01,0.1,1,10,100,1000,10000],
          ticktext: ["0.0001","0.001","0.01","0.1","1","10","100","1000","10000"]
        }
      };

      Plotly.newPlot("chart", [traceLine, traceMarker], layout);

      const chart = document.getElementById("chart");

      chart.on("mousemove", function(evt) {
        const bbox = chart.getBoundingClientRect();
        const xPixel = evt.clientX - bbox.left;

        const xaxis = chart._fullLayout.xaxis;
        const xVal = xaxis.p2l(xPixel); // pixelâ†’data (log included)

        if (isNaN(xVal) || xVal <= 0) return;

        // Find bracketing segment
        let i = 0;
        while (i < xs.length - 1 && xs[i+1] < xVal) {
          i++;
        }

        if (i < xs.length - 1) {
          // Interpolate in log-log space
          const x0 = Math.log10(xs[i]);
          const x1 = Math.log10(xs[i+1]);
          const y0 = Math.log10(ys[i]);
          const y1 = Math.log10(ys[i+1]);

          const t = (Math.log10(xVal) - x0) / (x1 - x0);
          const yVal = Math.pow(10, y0 + t * (y1 - y0));

          // Update marker position
          Plotly.restyle("chart", {
            x: [[xVal]],
            y: [[yVal]]
          }, [1]);
        }
      });

      chart.on("mouseleave", function() {
        Plotly.restyle("chart", {x: [[null]], y: [[null]]}, [1]);
      });
    }

    loadData();
  </script>
</body>
</html>
